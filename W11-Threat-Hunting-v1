-- 1. Auto-Starting Services (Persistence)
SELECT
  name         AS service_name,
  path         AS service_path,
  start_type,
  status
FROM services
WHERE start_type = 'AUTO_START'
ORDER BY name;

-- 2. Scheduled Tasks (Persistence & Recon)
SELECT
  name                                        AS task_name,
  path                                        AS task_path,
  action                                      AS task_action,
  enabled,
  datetime(last_run_time,  'unixepoch', 'localtime') AS last_run_time,
  datetime(next_run_time,  'unixepoch', 'localtime') AS next_run_time
FROM scheduled_tasks
WHERE enabled = 1
ORDER BY next_run_time DESC;

-- 3. Registry Autoruns (HKLM & HKCU)
SELECT
  CASE
    WHEN path LIKE 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run%' 
      THEN 'HKLM'
    WHEN path LIKE 'HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run%' 
      THEN 'HKCU'
    ELSE 'Other'
  END                              AS hive,
  path                             AS registry_key,
  name                             AS value_name,
  type                             AS value_type,
  data                             AS value_data
FROM registry
WHERE path LIKE 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run%' 
   OR path LIKE 'HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run%'
ORDER BY registry_key;

-- 4. Local Administrator Accounts (Privilege Audit)
SELECT
  u.username,
  u.description,
  u.directory                     AS home_directory
FROM users u
JOIN user_groups ug ON ug.uid = u.uid
JOIN groups g       ON g.gid = ug.gid
WHERE g.groupname = 'Administrators'
ORDER BY u.username;

-- 5. WMI Event Filters (Hidden-Exec Triggers)
SELECT
  name                            AS filter_name,
  query                           AS wql_query
FROM wmi_event_filters
ORDER BY name;

-- 6. Orphan Processes (Suspicious Parent PID = 0)
SELECT
  pid,
  name                            AS process_name,
  path                            AS process_path,
  parent                          AS parent_pid,
  datetime(start_time, 'unixepoch', 'localtime') AS start_time
FROM processes
WHERE parent = 0
ORDER BY start_time DESC;

-- 7. Listening Network Ports (External Contact)
SELECT
  lp.pid,
  p.name                          AS process_name,
  lp.protocol,
  lp.address,
  lp.port
FROM listening_ports lp
JOIN processes p ON p.pid = lp.pid
WHERE lp.address NOT IN ('127.0.0.1', '::1')
ORDER BY lp.port;

-- 8. PE Modules Not Signed by Microsoft (DLL Hijacks)
SELECT
  pm.name                         AS module_name,
  pm.path                         AS module_path,
  pm.pid,
  pm.signed_by                    AS signer
FROM pe_modules pm
WHERE pm.signed_by NOT LIKE '%Microsoft%'
ORDER BY pm.pid, pm.name;

-- 9. Recent Process Creations via Sysmon (Windows Event Log)
SELECT
  datetime(time_generated/1000, 'unixepoch', 'localtime') AS event_time,
  json_extract(event_data, '$.Image')      AS process_path,
  json_extract(event_data, '$.CommandLine')AS cmdline,
  json_extract(event_data, '$.User')       AS user
FROM windows_eventlog
WHERE channel = 'Microsoft-Windows-Sysmon/Operational'
  AND eventid = 1
ORDER BY event_time DESC
LIMIT 20;

-- 10. Loaded Kernel Drivers (Unsigned = Red Flag)
SELECT
  name                             AS driver_name,
  path                             AS driver_path,
  signed                           AS signature_status
FROM loaded_drivers
WHERE signed = 'Unsigned'
ORDER BY name;

-- 11. Recent PowerShell Script Blocks
SELECT
  datetime(time, 'unixepoch', 'localtime') AS exec_time,
  script_block_text                  AS ps_script
FROM windows_eventlog
WHERE channel = 'Microsoft-Windows-PowerShell/Operational'
  AND eventid IN (4103, 4104)
ORDER BY exec_time DESC
LIMIT 20;

-- 12. Recently Modified System32 Files (Integrity Check)
SELECT
  path                                AS file_path,
  datetime(mtime, 'unixepoch', 'localtime') AS modified_time,
  mode,
  size
FROM file
WHERE path LIKE 'C:/Windows/System32/%'
ORDER BY mtime DESC
LIMIT 20;

-- 13. Recently Logged-In Users
SELECT
  user,
  host,
  datetime(time, 'unixepoch', 'localtime')  AS login_time
FROM logged_in_users
ORDER BY login_time DESC
LIMIT 10;
